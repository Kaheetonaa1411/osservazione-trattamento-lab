<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Mappa dei chiodini</title>
    <meta property="og:description" content="Mappa dei chiodini" />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.js'></script>
    <style>
body {
  margin: 0;
  padding: 0;
}

	html,
	body,
	#map {
	  height: 100%;
	}
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <script>
      fetch("https://five.epicollect.net/api/export/entries/osstrat?form_ref=6ba1ee4c1b88489784753623318d44ac_690489e3714b9")
	.then((response) => response.json())
	.then((data) => {
		const MAPTILER_KEY = 'LNYmt0VUZ6v0kH5DVUYX';
		let entries = data['data']['entries']
		let points = [];
		let collection = [];
		let line_node=[];
		for (let i in entries) {
			console.log(entries[i])
			let p_c=[entries[i]['2_location']['longitude'], entries[i]['2_location']['latitude']]
			let p_f={
				'type': 'Feature',
				'properties': {
					'iconSize': [32, 32],
					'exist':entries[i]['4_chiodino'],
					'photo':entries[i]['3_photo']
				      },
				'geometry': {
					'type': 'Point',
					'coordinates': p_c
				      }
			      }
			points.push(p_f);
			line_node.push(p_c);
		      }

		var line = turf.lineString(line_node);
		var bbox = turf.bbox(line);
		//console.log(bbox);
		console.log(points)
		let points_geojson={'type': 'FeatureCollection','features':points}

		const map = new maplibregl.Map({
			container: 'map',
			zoom: 13,
			bounds: bbox,
			style: {
				version: 8,
				sources: {
					osm: {
						type: 'raster',
						tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
						tileSize: 256,
						attribution: '&copy; OpenStreetMap Contributors',
						maxzoom: 19
					      }
				      },
				layers: [
					{
						id: 'osm',
						type: 'raster',
						source: 'osm'
					      }
				      ]
			      },
			maxZoom: 18,
			pitch: 60,
			maxPitch: 85
		      });

		map.on('load', () => {

			const layers = map.getStyle().layers;

			let labelLayerId;
			for (let i = 0; i < layers.length; i++) {
				if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
					labelLayerId = layers[i].id;
					break;
				      }
			      }

			map.addSource('openmaptiles', {
				url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`,
				type: 'vector',
			      });

			map.addLayer(
				{
					'id': '3d-buildings',
					'source': 'openmaptiles',
					'source-layer': 'building',
					'type': 'fill-extrusion',
					'minzoom': 15,
					'filter': ['!=', ['get', 'hide_3d'], true],
					'paint': {
						'fill-extrusion-opacity': 0.3,
						'fill-extrusion-color': [
							'interpolate',
							['linear'],
							['get', 'render_height'], 0, 'lightgray', 200, 'royalblue', 400, 'lightblue'
						      ],
						'fill-extrusion-height': [
							'interpolate',
							['linear'],
							['zoom'],
							15,
							0,
							16,
							['get', 'render_height']
						      ],
						'fill-extrusion-base': ['case',
							['>=', ['get', 'zoom'], 16],
							['get', 'render_min_height'], 0
						      ]
					      }
				      },
				labelLayerId
			      );


			points_geojson.features.forEach((marker) => {
				// create a DOM element for the marker
				console.log(marker)
				const el = document.createElement('div');
				el.className = 'marker';
				switch(marker.properties.exist) {
					case "si":
					  el.style.backgroundImage ='url("asset/nail32-blue.png")';
					  break;

					case "no":
					  el.style.backgroundImage ='url("asset/nail32-red.png")';
					  break;
				      }
				el.style.width = `${marker.properties.iconSize[0]}px`;
				el.style.height = `${marker.properties.iconSize[1]}px`;
				el.style.position= "absolute";
				el.style.top = "-16px";
				el.style.left="16px";

				el.addEventListener('click', () => {
					window.open(marker.properties.photo);
				      });

				// add marker to map
				new maplibregl.Marker({element: el})
				  .setLngLat(marker.geometry.coordinates)
				  .addTo(map);
			      });
		      })
	      })

    </script>
  </body>

</html>
